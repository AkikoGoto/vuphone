<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Wreck Watch Map</title>
<script src="jquery/jquery-1.3.2.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="jquery/jquery.timers.js"></script>
<script type="text/javascript" src="datepicker.js"></script>

<script
	src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAABWCNt87qa4B0xMt7qCbeOhSUJe7as4HRkTSp8W_Y5vZTzgBsVRRK2y9QPUsVV97Efab1bIzjFmYggQ"
	type="text/javascript"></script>
	

	

<script type="text/javascript">

	var map;
	var events = new Array();
	var routes = new Array();
	var days = new Array("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday");
	var months = new Array("January", "February", "March", "April", "May", "June", "July", "August", 
			"September", "October", "November", "December");
	var showEvents = true;
	var showRoutes = true;
	var lastClicked = new Event();
	var curHtml;
	var recordLocation = false;
	lastClicked.setId(0);
	
    var eventCallback = function (data, textStatus){
    	$.each(data.EventRequestResponse, processEventItem);
    }
    var metaCallback = function (data, textStatus){
        curHtml = "<b>Event Name: </b>" + lastClicked.name;
        var start = new Date(lastClicked.starttime);
        var end = new Date(lastClicked.endtime);

        var ap1;
        var ap2;
        if (start.getHours() > 12) {ap1 = "PM"}
        if (end.getHours() > 12) {ap2 = "PM"}
        
        curHtml = curHtml + "<br /><b>Start Time: </b>" + days[start.getDay()] + " " + months[start.getMonth()] +
        			", " + start.getDate() + " " + start.getFullYear() + " " + start.getHours() % 12 + ":" 
        			+ start.getMinutes() + " " + ap1 + 
        			"<br /><b>End Time: </b>" + days[end.getDay()] + " " + months[end.getMonth()] +
        			", " + end.getDate() + " " + end.getFullYear() + " " + end.getHours() % 12 + ":" 
        			+ end.getMinutes() + " " + ap2;
    	$.each(data.EventMetaRequestResponse, processMetaItem);
    	lastClicked.marker.openInfoWindowHtml(curHtml);
    }

    function processMetaItem(i, item){
        if (item.Type == "DESCRIPTION"){
            curHtml = curHtml + "<br /><b>Description: </b>" + item.Value;
        }else if (item.Type == "IMAGE"){
            curHtml = curHtml + "<br /><b>Image: </b><img src=\"" + item.Value + "\" />";
        }else if (item.Type == "HOSTING_ORG"){
            curHtml = curHtml + "<br /><b>Hosting Organization:</b> " + item.Value;
        } 
        
    }

    var handleMapClick = function(overlay, latlng){
    	 
        if (recordLocation){
            $("#evtLat").attr("value", latlng.y);
            $("#evtLon").attr("value", latlng.x);
            $("#createEventWindow").css("visibility", "visible");
            recordLoction = false;	        
        }else{
           
            if (this.getLatLng()){
            	var temp = null;
	            var latlng = this.getLatLng();
	        	
		        map.panTo(latlng);
		
		        //This needs to be reworked
		        $.each(events, function(i, item){
		            if (item.lat == latlng.lat() && item.lon == latlng.lng()){
		                temp = item;
		            }
		        });
	
		    
		        getMetaData(temp.eventid);
		
		        lastClicked = temp;
            }
        }
        
    }


    function processEventItem(i, item){
		var temp = new Event();
		temp.setLat(item.Loc.Lat);
		temp.setLon(item.Loc.Lon);
		temp.setStartTime(item.Start);
		temp.setEndTime(item.End);
		temp.setId(item.EventId);
		temp.setName(item.Name);
		temp.setMarker(new GMarker(new GLatLng(temp.lat, temp.lon)));
		var skip = false;
        $.each(events, function(j, item2){
            if (item2.equals(temp)){
				skip = true;
            }
            
        });

        if (!skip){
         	events.push(temp);
          	GEvent.addListener(temp.marker, "click", handleMapClick);
            map.addOverlay(temp.marker);
        }
    }


    
    $(document).ready(function(){
    	 if (GBrowserIsCompatible()) {
             map = new GMap2(document.getElementById("map_canvas"));
             map.enableContinuousZoom();
             map.enableScrollWheelZoom();
             map.addControl(new GSmallMapControl());
             map.addControl(new GMapTypeControl());
             map.setCenter(new GLatLng(36.1477864065951, -86.80392265319824), 15);
             getEventData();

    	 }

    	 $("#createEvent").click(function(){
        	 $("#createEventWindow").css("visibility", "visible");

         });

         $("#selectLocation").click(function(){
        	 $("#createEventWindow").css("visibility", "hidden");
        	 recordLocation = true;
             
         });

         $("#selectStartDate").click(function(){
        	 displayDatePicker('startDate');
         });

         GEvent.addListener(map, "click", handleMapClick);
    });

    function getEventData(){
        var bnds = map.getCenter();
        var qry = "http://localhost:8080/vandyupon/events/?type=eventrequest&lat="+bnds.lat()+"&lon="+bnds.lng() + 
                "&dist=10560&resp=json&callback=?";
    	$.getJSON(qry, eventCallback);
    }

    function getMetaData(id){
        var qry = "http://localhost:8080/vandyupon/events/?type=eventmetarequest&id=" + id + "&resp=json&callback=?";
    	$.getJSON(qry, metaCallback);
    }
    
    function Event(){

    	this.setName = function(name){
        	this.name = name;
    	}
    	this.setLat = function (lat){
    		this.lat=lat;
    	}
    	this.setLon = function(lon){
    		this.lon = lon;
    	}
    	this.setStartTime = function(time){
    		this.starttime = time;
    	}
    	this.setEndTime = function(time){
        	this.endtime = time;
    	}
    	this.setId = function(id){
    		this.eventid = id;
    	}
    	this.setMarker = function(marker){
        	this.marker = marker;
    	}
    	this.equals = function(wreck){
        	return (this.wreckid == wreck.wreckid);  
    	}
    }   


      </script>
      
      <style>
        table, tbody, tfoot, thead, tr, th, td {
		    margin: 0;
		    padding: 0;
		    border: 0;
		    outline: 0;
		    font-weight: inherit;
			font-style: inherit;
			font-size: 100%;
			font-family: inherit;
		}

		table {
			border-collapse: separate;
			border-spacing: 0;
		}
		
		html, body { 
			margin:0; 
			padding:0; 
			height:100%; 
		}
      </style>
</head>
<body onunload="GUnload()" style="font-family: Arial; border: 0 none; background:rgb(100,100,100);">

<div id="map_canvas" style="position:absolute; z-index:0; width: 100%; height: 80%; margin-top:75px;"></div>


<div style="background:url('images/hb.png'); width:100%; height:75px; position:absolute; top:0px; left:0px;">
   <img src="images/vandy.png"></img>&nbsp;&nbsp;<img src="images/ww.png"></img>
</div>



<div style="width:100%; height:73px; background:url('images/hbd.png')"><span style="font-size:.6em">by Chris Thompson, Hamilton Turner, Krzysztof Zienkiewicz, Scott Campbell, Brian Dougherty, Jules White, and Douglas C. Schmidt</span></div>


<div id="control" style="position:absolute; left:30px; top:365px; align:center; text-align:center; ">
 <div style="width:150px; height:73px; background:url('images/pal.png'); ">&nbsp;</div>
 <div style="background:rgb(200,200,200); height:100%; width:120px; margin-left:13px; border:solid 2px rgb(100,100,100)">
     <p><input type="button" id="createEvent" value="Create Event" /></p>
     
  </div>
  <div style="width:150px; height:73px; background:url('images/palb.png')"></div>
</div>

<div id="createEventWindow" style="position:absolute; z-index:3; border: 5px solid black; background-color:#FFFFFF; width:300px; height:200px; margin-left: 100px; margin-top:50px; visibility:hidden;">
	<table>
		<tr>
			<td><b>Event Name: </b></td>
			<td><input type="text" name="evtName" value="" /></td>
		</tr>
		<tr>
			<td colspan="2"><a href="#" id="selectLocation">Select Location</a></td>
		</tr>
		<tr>
			<td><b>Latitude: </b></td>
			<td><input type="text" id="evtLat" value="" disabled="true" /></td>
		</tr>
		<tr>
			<td><b>Longitude: </b></td>
			<td><input type="text" id="evtLon" value="" disabled="true" /></td>
		</tr>
		<tr>
			<td colspan="2">&nbsp;</td>
		</tr>
		<tr>
			<td><b>Start Date: </b></td>
			<td><input type="text" name="startDate" value="" disabled="true" /></td>
		</tr>
		<tr>
			<td colspan="2"><a href="#" id="selectStartDate">Select Start Date</a></td>
		</tr>
		<tr>
			<td><b>Start Time: </b></td>
			<td><input type="text" name="startTime" value="" disabled="true" /></td>
		</tr>
		<tr>
			<td colspan="2"><b>Event Description: </b></td>
		</tr>
		<tr>
			<td colspan="2"><textarea rows="3" cols="30"></textarea></td>
		</tr>
	</table>
	<br style="clear:all;" />
</div>

</body>
</html>

